<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Remises Uploader</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .right-btn {
            margin-left: auto;
        }
        button { margin: 10px; padding: 10px 20px; font-size: 16px; }
        .remise-block { margin-bottom: 40px; }
        table { border-collapse: collapse; margin-top: 20px; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f0f0f0; }
        input[type="file"] { display: none; }
        .totalAmount { margin-top: 10px; font-weight: bold; }
        .remise-title { font-size: 18px; margin-top: 20px; }
        #generateLotBtn { background: #4CAF50; color: white; }
        .upload-status { margin: 10px 0; font-weight: bold; color: #666; }
    </style>
</head>
<body>
    <h1>Remises Uploader</h1>
    <div class="top-bar" id="topBar">
        <button onclick="document.getElementById('remisesInput').click()">Add Remises (.remise)</button>
        <div class="right-btn">
            <button id="generateLotBtn" onclick="generateLotFile()" disabled>Generate LOT file</button>
        </div>
    </div>
    <input id="remisesInput" type="file" accept=".remise" multiple onchange="handleFiles(event)">
    <div class="upload-status" id="uploadStatus"></div>
    <div id="remisesContainer"></div>
    <script>
        let serverDirectoryPath = null;

        window.onload = function() {
            fetchAndDisplayRemises();
        };

        function handleFiles(event) {
            const files = event.target.files;
            if (!files.length) return;

            serverDirectoryPath = null;
            const statusDiv = document.getElementById("uploadStatus");
            statusDiv.textContent = "Uploading files to server...";
            statusDiv.style.color = "#666";

            uploadFilesToServer(files).then(() => {
                fetchAndDisplayRemises();
            }).catch(error => {
                statusDiv.textContent = "Upload failed: " + error.message;
                statusDiv.style.color = "red";
            });
        }

        function uploadFilesToServer(files) {
            const formData = new FormData();
            Array.from(files).forEach(file => {
                formData.append('files', file);
            });

            return fetch('/api/upload/remises', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                return response.json();
            })
            .then(data => {
                serverDirectoryPath = data.directoryPath;
                document.getElementById("uploadStatus").textContent =
                    "Files uploaded successfully to: " + serverDirectoryPath;
                document.getElementById("uploadStatus").style.color = "green";
            });
        }

        function fetchAndDisplayRemises() {
            fetch('/api/remises/list')
                .then(response => response.json())
                .then(remises => {
                    const container = document.getElementById("remisesContainer");
                    container.innerHTML = "";
                    if (remises.length === 0) {
                        document.getElementById("generateLotBtn").disabled = true;
                        return;
                    }
                    remises.forEach(remise => {
                        fetchRemiseFileAndDisplay(remise.filePath, remise.fileName);
                    });
                    document.getElementById("generateLotBtn").disabled = false;
                });
        }

        function fetchRemiseFileAndDisplay(filePath, fileName) {
            fetch('/api/remises/file?path=' + encodeURIComponent(filePath))
                .then(response => response.text())
                .then(content => {
                    const lines = content.split(/\r?\n/).filter(line => line.trim() !== "");
                    if (lines.length < 2) return;
                    let total = 0;
                    const table = document.createElement("table");
                    const thead = document.createElement("thead");
                    thead.innerHTML = `
                        <tr>
                            <th>RIO</th>
                            <th>Operation Type</th>
                            <th>Beneficiary RIB</th>
                            <th>Beneficiary Bank</th>
                            <th>Cheque Number</th>
                            <th>Sender RIB</th>
                            <th>Sender Bank</th>
                            <th>Amount</th>
                        </tr>`;
                    table.appendChild(thead);
                    const tbody = document.createElement("tbody");
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(".");
                        if (values.length !== 8) continue;
                        const row = document.createElement("tr");
                        values.forEach((val, idx) => {
                            const cell = document.createElement("td");
                            cell.textContent = val;
                            row.appendChild(cell);
                            if (idx === 7) {
                                const amount = parseFloat(val.replace(",", "."));
                                if (!isNaN(amount)) total += amount;
                            }
                        });
                        tbody.appendChild(row);
                    }
                    table.appendChild(tbody);
                    const block = document.createElement("div");
                    block.className = "remise-block";
                    const title = document.createElement("div");
                    title.className = "remise-title";
                    title.textContent = "Remise: " + fileName;
                    const totalDiv = document.createElement("div");
                    totalDiv.className = "totalAmount";
                    totalDiv.textContent = "Total Amount: " + total;
                    block.appendChild(title);
                    block.appendChild(table);
                    block.appendChild(totalDiv);
                    document.getElementById("remisesContainer").appendChild(block);
                });
        }

        function generateLotFile() {
            // Use the latest uploaded directory if available, else use the last session dir
            if (!serverDirectoryPath) {
                // Try to get the latest session dir from the displayed remises
                fetch('/api/remises/list')
                    .then(response => response.json())
                    .then(remises => {
                        if (remises.length === 0) return;
                        // Find the session dir of the last uploaded remise
                        const lastSession = remises[remises.length - 1].session;
                        const dir = '/uploads/remises/' + lastSession;
                        launchJob(dir);
                    });
            } else {
                launchJob(serverDirectoryPath);
            }
        }

        function launchJob(remisesDir) {
            const btn = document.getElementById("generateLotBtn");
            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = "Launching Job...";

            fetch("/runJob", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ remisesDir: remisesDir })
            })
            .then(response => response.text())
            .then(result => {
                alert(result);
            })
            .catch(error => {
                alert("Error launching job: " + error.message);
            })
            .finally(() => {
                btn.textContent = oldText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
